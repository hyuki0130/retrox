name: E2E Tests (iOS)

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'mobile/**'
      - '.github/workflows/e2e-ios.yml'
  push:
    branches: [main]
    paths:
      - 'mobile/**'
      - '.github/workflows/e2e-ios.yml'

jobs:
  e2e-ios:
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: Install Detox CLI
        run: npm install -g detox-cli

      - name: Install applesimutils
        run: |
          brew tap wix/brew
          brew install applesimutils
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1
          HOMEBREW_NO_INSTALL_CLEANUP: 1

      - name: Install dependencies
        working-directory: mobile
        run: npm ci

      - name: Cache CocoaPods
        id: cache-cocoapods
        uses: actions/cache@v4
        with:
          path: |
            mobile/ios/Pods
            ~/Library/Caches/CocoaPods
          key: pods-${{ runner.os }}-${{ hashFiles('mobile/ios/Podfile.lock') }}
          restore-keys: |
            pods-${{ runner.os }}-

      - name: Install CocoaPods
        if: steps.cache-cocoapods.outputs.cache-hit != 'true'
        working-directory: mobile/ios
        run: pod install --repo-update

      - name: Cache Detox Framework
        id: cache-detox-framework
        uses: actions/cache@v4
        with:
          path: ~/Library/Detox/ios
          key: detox-framework-${{ runner.os }}-${{ hashFiles('mobile/package-lock.json') }}

      - name: Rebuild Detox Framework Cache
        if: steps.cache-detox-framework.outputs.cache-hit != 'true'
        run: detox rebuild-framework-cache

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: mobile/ios/build
          key: derived-data-${{ runner.os }}-${{ hashFiles('mobile/ios/Podfile.lock', 'mobile/package-lock.json') }}
          restore-keys: |
            derived-data-${{ runner.os }}-

      - name: Boot iOS Simulator
        run: |
          xcrun simctl boot "iPhone 15 Pro" || true
          xcrun simctl bootstatus "iPhone 15 Pro" -b

      - name: Build for Detox
        working-directory: mobile
        run: detox build --configuration ios.sim.release

      - name: Run E2E Tests
        working-directory: mobile
        run: detox test --configuration ios.sim.release --cleanup --headless

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: detox-artifacts
          path: mobile/artifacts/
